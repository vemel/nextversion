name: Assign PullRequest labels

on:
  pull_request:
    types: [opened, edited]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Analyze PR notes
        id: notes
        uses: vemel/nextchange@main
        with:
          save: "false"
          set: ${{ github.event.pull_request.body }}
      - name: Build labels
        uses: actions/github-script@v3
        id: labels
        with:
          script: |
            const managedLabels = ['patch', 'minor', 'major'];
            const labels = context.payload.pull_request.labels.map(data => data.name).filter(label => !managedLabels.includes(label));
            const label = ${{ toJSON(steps.notes.outputs.label) }};
            const newLabels = [...labels, label];
            console.log("New labels:", newLabels);
            return newLabels;
      - name: Assign labels
        uses: actions/github-script@v3
        with:
          script: |
            const labels = ${{ steps.labels.outputs.result }}
            console.log('Assigned labels', labels)
            await github.issues.setLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: labels
            })
